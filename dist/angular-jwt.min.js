angular.module("angular-jwt",["base64","angular-jwt.options","angular-jwt.interceptor","angular-jwt.jwt","angular-jwt.authManager"]),angular.module("angular-jwt.authManager",["base64"]).provider("authManager",function(){this.$get=["$rootScope","$injector","$location","jwtHelper","jwtInterceptor","jwtOptions",function(e,r,t,n,a,i){var o=i.getConfig();function u(t){return Array.isArray(t)?r.invoke(t,this,{options:null}):t()}function s(t){if(Array.isArray(t)||angular.isFunction(t))return r.invoke(t,o,{});throw new Error("unauthenticatedRedirector must be a function")}function c(){var t=u(o.tokenGetter);if(t)return!n.isTokenExpired(t)}function h(){e.isAuthenticated=!0}function l(){e.isAuthenticated=!1}function d(){var t=u(o.tokenGetter);t&&(n.isTokenExpired(t)?e.$broadcast("tokenHasExpired",t):h())}if(e.isAuthenticated=!1,r.has("$transitions"))r.get("$transitions").onBefore({},function(t){var e=t.to();if(t.router.stateService,e&&e.data&&!0===e.data.requiresLogin&&!c())throw t.promise.catch(function(t){s(o.unauthenticatedRedirector)}),"JWT: unauthenticated"});else{var f=r.has("$state")?"$stateChangeStart":"$routeChangeStart";e.$on(f,function(t,e){if(!e)return!1;var r=e.$$route?e.$$route:e.data;r&&!0===r.requiresLogin&&!c()&&(t.preventDefault(),s(o.unauthenticatedRedirector))})}return{authenticate:h,unauthenticate:l,getToken:function(){return u(o.tokenGetter)},redirect:function(){return s(o.unauthenticatedRedirector)},checkAuthOnRefresh:function(){r.has("$transitions")?r.get("$transitions").onStart({},d):e.$on("$locationChangeStart",d)},redirectWhenUnauthenticated:function(){e.$on("unauthenticated",function(){s(o.unauthenticatedRedirector),l()})},isAuthenticated:c}}]}),angular.module("angular-jwt.interceptor",["base64"]).provider("jwtInterceptor",function(){this.urlParam,this.authHeader,this.authPrefix,this.whiteListedDomains,this.tokenGetter;var a=this;this.$get=["$q","$injector","$rootScope","urlUtils","jwtOptions",function(r,t,e,i,n){var o=angular.extend({},n.getConfig(),a);return{request:function(e){if(e.skipAuthorization||!function(t){if(!i.isSameOrigin(t)&&!o.whiteListedDomains.length)throw new Error("As of v0.1.0, requests to domains other than the application's origin must be white listed. Use jwtOptionsProvider.config({ whiteListedDomains: [<domain>] }); to whitelist.");for(var e=i.urlResolve(t).hostname.toLowerCase(),r=0;r<o.whiteListedDomains.length;r++){var n=o.whiteListedDomains[r],a=n instanceof RegExp?n:new RegExp(n,"i");if(e.match(a))return!0}return!!i.isSameOrigin(t)}(e.url))return e;if(o.urlParam){if(e.params=e.params||{},e.params[o.urlParam])return e}else if(e.headers=e.headers||{},e.headers[o.authHeader])return e;return r.when(t.invoke(o.tokenGetter,this,{options:e})).then(function(t){return t&&(o.urlParam?e.params[o.urlParam]=t:e.headers[o.authHeader]=o.authPrefix+t),e})},responseError:function(t){return 401===t.status&&e.$broadcast("unauthenticated",t),r.reject(t)}}}]}),angular.module("angular-jwt.jwt",["base64"]).service("jwtHelper",["$window","$base64",function(r,n){this.urlBase64Decode=function(t){var e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}return r.decodeURIComponent(escape(n.decode(e)))},this.decodeToken=function(t){var e=t.split(".");if(3!==e.length)throw new Error("JWT must have 3 parts");var r=this.urlBase64Decode(e[1]);if(!r)throw new Error("Cannot decode the token");return angular.fromJson(r)},this.getTokenExpirationDate=function(t){var e=this.decodeToken(t);if(void 0===e.exp)return null;var r=new Date(0);return r.setUTCSeconds(e.exp),r},this.isTokenExpired=function(t,e){var r=this.getTokenExpirationDate(t);return e=e||0,null!==r&&!(r.valueOf()>(new Date).valueOf()+1e3*e)}}]),angular.module("angular-jwt.options",["base64"]).provider("jwtOptions",function(){var r={};this.config=function(t){r=t},this.$get=function(){var t={urlParam:null,authHeader:"Authorization",authPrefix:"Bearer ",whiteListedDomains:[],tokenGetter:function(){return null},loginPath:"/",unauthenticatedRedirectPath:"/",unauthenticatedRedirector:["$location",function(t){t.path(this.unauthenticatedRedirectPath)}]};function e(){this.config=angular.extend({},t,r)}return e.prototype.getConfig=function(){return this.config},new e}}),angular.module("angular-jwt.interceptor").service("urlUtils",function(){var r=document.createElement("a"),n=a(window.location.href);function a(t){var e=t;return r.setAttribute("href",e),e=r.href,r.setAttribute("href",e),{href:r.href,protocol:r.protocol?r.protocol.replace(/:$/,""):"",host:r.host,search:r.search?r.search.replace(/^\?/,""):"",hash:r.hash?r.hash.replace(/^#/,""):"",hostname:r.hostname,port:r.port,pathname:"/"===r.pathname.charAt(0)?r.pathname:"/"+r.pathname}}return{urlResolve:a,isSameOrigin:function(t){var e=angular.isString(t)?a(t):t;return e.protocol===n.protocol&&e.host===n.host}}});